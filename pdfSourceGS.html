<html><head><meta charset="UTF-8"><script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-bash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-markup.min.js"></script><style>
        .article {
            position: relative;
            padding-bottom: 24px;
        }
        

        .code-block {
            overflow: hidden;
            position: relative;
            padding: 0;
            border-radius: 8px;
            font-variant-ligatures: none;
            background-color: rgba(25, 25, 28, .05);
            word-break: break-all;
        }
        

        .control {
            color: #19191c;
            font-size: 16px;
            font-weight: 670;
        }
        

        .detached {
            margin-block-start: 0;
            margin-block-end: 0;
            margin-bottom: 8px;
        }
        

        .emphasis {
            color: inherit;
            font-weight: inherit;
            font-style: italic;
        }
        

        .inline-code {
            border-radius: 4px;
            display: inline;
            padding: 2px 1px;
            font-family: JetBrains Sans,monospace;
            background: #e6e6e6;
        }
        

        .list {
            list-style-type: disc;
            padding-left: 0;
            margin-left: 15px;
        }
        

        .list-decimal {
            list-style-type: decimal;
        }
        

        .list-item {
            margin-top: 6px;
            margin-bottom: 6px;
            margin-left: 4px;
        }
        

        .main-title {
            padding-bottom: 24px;
            margin-top: 0;
            font-size: 40px;
            margin-block-start: 0;
            margin-block-end: 0;
        }
        

        .prism {
            page-break-inside: avoid;
        }
        
        /* PrismJS 1.29.0
https://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript+abap+abnf+actionscript+ada+agda+al+antlr4+apacheconf+apex+apl+applescript+aql+arduino+arff+armasm+arturo+asciidoc+aspnet+asm6502+asmatmel+autohotkey+autoit+avisynth+avro-idl+awk+bash+basic+batch+bbcode+bbj+bicep+birb+bison+bnf+bqn+brainfuck+brightscript+bro+bsl+c+csharp+cpp+cfscript+chaiscript+cil+cilkc+cilkcpp+clojure+cmake+cobol+coffeescript+concurnas+csp+cooklang+coq+crystal+css-extras+csv+cue+cypher+d+dart+dataweave+dax+dhall+diff+django+dns-zone-file+docker+dot+ebnf+editorconfig+eiffel+ejs+elixir+elm+etlua+erb+erlang+excel-formula+fsharp+factor+false+firestore-security-rules+flow+fortran+ftl+gml+gap+gcode+gdscript+gedcom+gettext+gherkin+git+glsl+gn+linker-script+go+go-module+gradle+graphql+groovy+haml+handlebars+haskell+haxe+hcl+hlsl+hoon+http+hpkp+hsts+ichigojam+icon+icu-message-format+idris+ignore+inform7+ini+io+j+java+javadoc+javadoclike+javastacktrace+jexl+jolie+jq+jsdoc+js-extras+json+json5+jsonp+jsstacktrace+js-templates+julia+keepalived+keyman+kotlin+kumir+kusto+latex+latte+less+lilypond+liquid+lisp+livescript+llvm+log+lolcode+lua+magma+makefile+markdown+markup-templating+mata+matlab+maxscript+mel+mermaid+metafont+mizar+mongodb+monkey+moonscript+n1ql+n4js+nand2tetris-hdl+naniscript+nasm+neon+nevod+nginx+nim+nix+nsis+objectivec+ocaml+odin+opencl+openqasm+oz+parigp+parser+pascal+pascaligo+psl+pcaxis+peoplecode+perl+php+phpdoc+php-extras+plant-uml+plsql+powerquery+powershell+processing+prolog+promql+properties+protobuf+pug+puppet+pure+purebasic+purescript+python+qsharp+q+qml+qore+r+racket+cshtml+jsx+tsx+reason+regex+rego+renpy+rescript+rest+rip+roboconf+robotframework+ruby+rust+sas+sass+scss+scala+scheme+shell-session+smali+smalltalk+smarty+sml+solidity+solution-file+soy+sparql+splunk-spl+sqf+sql+squirrel+stan+stata+iecst+stylus+supercollider+swift+systemd+t4-templating+t4-cs+t4-vb+tap+tcl+tt2+textile+toml+tremor+turtle+twig+typescript+typoscript+unrealscript+uorazor+uri+v+vala+vbnet+velocity+verilog+vhdl+vim+visual-basic+warpscript+wasm+web-idl+wgsl+wiki+wolfram+wren+xeora+xml-doc+xojo+xquery+yaml+yang+zig&plugins=highlight-keywords */
code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre-wrap;word-spacing:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:16px;margin:0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}

        

        :root {
            width: 95%;
            max-width: 95vw;
            padding: 0 0 0 30px;
        }
        
        body {
            font-family: JetBrains Sans,serif;
        }
        
        a {
            overflow-wrap: anywhere;
            width: 100vw;
        }
        
        
        @font-face {
            font-family: JetBrains Sans;
            src: url(https://resources.jetbrains.com/storage/jetbrains-sans/JetBrainsSans-Light.woff2) format("woff2"), url(https://resources.jetbrains.com/storage/jetbrains-sans/JetBrainsSans-Light.woff) format("woff");
            font-weight: 300;
            font-style: normal;
        }

        @font-face {
            font-family: JetBrains Sans;
            src: url(https://resources.jetbrains.com/storage/jetbrains-sans/JetBrainsSans-Regular.woff2) format("woff2"), url(https://resources.jetbrains.com/storage/jetbrains-sans/JetBrainsSans-Regular.woff) format("woff");
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: JetBrains Sans;
            src: url(https://resources.jetbrains.com/storage/jetbrains-sans/JetBrainsSans-SemiBold.woff2) format("woff2"), url(https://resources.jetbrains.com/storage/jetbrains-sans/JetBrainsSans-SemiBold.woff) format("woff");
            font-weight: 600;
            font-style: normal;
        }
        
        
        code {
            display: inline;
            word-break: break-word;
            font-size: 15px;
            line-height: inherit;
            font-variant-ligatures: none;
            font-family: JetBrains Sans,monospace;
            white-space: pre-line;
            overflow-wrap: break-word;
        }
        
        figcaption {
            margin-top: 5px;
        }
        
        h2 {
            padding-top: 16px;
            padding-bottom: 8px;
            margin-block-start: 0;
            margin-block-end: 0;
        }
        
        h3 {
            padding-top: 8px;
            padding-bottom: 8px;
            margin-block-start: 0;
            margin-block-end: 0;
        }
        
        h4 {
            padding-top: 4px;
            padding-bottom: 8px;
            margin-block-start: 0;
            margin-block-end: 0;
        }
        
        p {
            padding: 0;
            border: 0;
            line-height: 25px;
            margin-block-start: 0;
            margin-block-end: 0;
            padding-bottom: 8px;
        }
        
        div {
            display: block;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            page-break-inside: avoid;
        }
        
        th, td {
            border: 1px solid #c4c4c4;
            padding: 10px;
            text-align: left;
            word-break: break-all;
        }
        
        .entry {
            display: grid;
            grid-template-columns: auto max-content;
            grid-template-areas: "chapter page";
            align-items: end;
            gap: 0 .25rem;
            line-height: 25px;
        }
        
        .toc-link-container{
            grid-area: chapter;
            position: relative;
            overflow: hidden;
        }
        
        .toc-link{
            text-decoration: none;
            color: black;
        }
        
        .toc-link-container::after {
            position: absolute;
            padding-left: .25ch;
            content: " . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . "
            ". . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . "
            ". . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . ";
            text-align: right;
        }
        
        .page {
            grid-area: page;
            width: 30px;
            text-align: right;
        }
        

        .topic {
            page-break-before: always;
        }
        </style></head><body><div><section class="topic"><div><article class="article"><h1 class="main-title">Table of contents</h1><div class="entry"><div class="toc-link-container"><a class="toc-link" href="#1469606077">Getting Started</a></div><div class="page">2</div></div><div class="entry"><div class="toc-link-container"><a class="toc-link" href="#2092192844">Setting up virtual machine</a></div><div class="page">7</div></div><div class="entry"><div class="toc-link-container"><a class="toc-link" href="#617518144">VM Configuration</a></div><div class="page">8</div></div></article></div></section><section class="topic"><div><article class="article"><h1 class="main-title" id="1469606077">Getting Started</h1><p id="1469606077#-doz6rh_3">Here is what I've learned regarding Virtualization in Arch Linux (btw)</p><p id="1469606077#-doz6rh_4">At the end of this guide we will have a nice Windows 11 VM with pass-through GPU NVIDIA, and seamless capture of mouse and keyboard.</p><p id="1469606077#-doz6rh_5">We will use <span class="control" id="1469606077#-doz6rh_15">KVM / QEMU</span> with <span class="control" id="1469606077#-doz6rh_16">libvirt</span> and our GUI will be <span class="control" id="1469606077#-doz6rh_17">virt-manager</span></p><p id="1469606077#-doz6rh_6">Arch Linux uses PipeWire for audio (this we'll use for sending guest audio back to host, without the needs of a virtual monitor attached)</p><p id="1469606077#-doz6rh_7">I won't use <span class="control" id="1469606077#-doz6rh_18">Spice</span> or <span class="control" id="1469606077#-doz6rh_19">Looking Glass</span>, therefore you will need to use a monitor hooked into your PCI GPU.</p><section><h2 id="1469606077#before-you-start" data-toc="before-you-start#GettingStarted.md-before-you-start">Before you start</h2><p id="1469606077#-doz6rh_20">List of the prerequisites that are required or recommended.</p><p id="1469606077#-doz6rh_21">Make sure that:</p><ul class="list" id="1469606077#-doz6rh_22" start="1"><li class="list-item" id="1469606077#-doz6rh_24"><p>First: Your CPU and your MB Must be compatible with Virtualization, IOMMU.</p></li><li class="list-item" id="1469606077#-doz6rh_25"><p>Second: You have at least 2 GPUS, internal GPU from an intel/amd CPU chip (APU) works.</p></li></ul><p id="1469606077#-doz6rh_23">We are going to also follow the reference from this wiki Arch Wiki (<a href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF">https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF</a>)</p></section><section><h2 id="1469606077#1-setting-up-bios" data-toc="1-setting-up-bios#GettingStarted.md-1-setting-up-bios">1. Setting up BIOS</h2><p id="1469606077#-doz6rh_27">First of all you need to go to your BIOS settings and activate:</p><ol class="list list-decimal" id="1469606077#-doz6rh_28" type="1" start="1"><li class="list-item" id="1469606077#-doz6rh_29"><section><h3 id="1469606077#virtualization-extensions" data-toc="virtualization-extensions#GettingStarted.md-virtualization-extensions">Virtualization Extensions</h3><section><h4 id="1469606077#intel-vt-x-intel-virtualization-technology-for-x86" data-toc="intel-vt-x-intel-virtualization-technology-for-x86#GettingStarted.md-intel-vt-x-intel-virtualization-technology-for-x86">Intel VT-x (Intel Virtualization Technology for x86)</h4><ul class="list" id="1469606077#-doz6rh_34" start="1"><li class="list-item" id="1469606077#-doz6rh_35"><p id="1469606077#-doz6rh_37">What: Allows a CPU to act as if you have multiple independent computers, called virtual machines (VMs).</p></li><li class="list-item" id="1469606077#-doz6rh_36"><p id="1469606077#-doz6rh_38">How: In BIOS/UEFI, look for options like &quot;Intel Virtualization Technology,&quot; &quot;VT-x,&quot; or &quot;Intel VT-x,&quot; and enable them.</p></li></ul></section><section><h4 id="1469606077#amd-v-amd-virtualization" data-toc="amd-v-amd-virtualization#GettingStarted.md-amd-v-amd-virtualization">AMD-V (AMD Virtualization)</h4><ul class="list" id="1469606077#-doz6rh_39" start="1"><li class="list-item" id="1469606077#-doz6rh_40"><p id="1469606077#-doz6rh_42">What: Similar to Intel VT-x, it allows hardware-assisted virtualization on AMD processors.</p></li><li class="list-item" id="1469606077#-doz6rh_41"><p id="1469606077#-doz6rh_43">How: In BIOS/UEFI, find settings like &quot;SVM Mode&quot; or &quot;Secure Virtual Machine&quot; and enable them.</p></li></ul></section></section></li><li class="list-item" id="1469606077#-doz6rh_30"><section><h3 id="1469606077#iommu-input-output-memory-management-unit" data-toc="iommu-input-output-memory-management-unit#GettingStarted.md-iommu-input-output-memory-management-unit">IOMMU (Input-Output Memory Management Unit)</h3><ul class="list" id="1469606077#-doz6rh_45" start="1"><li class="list-item" id="1469606077#-doz6rh_48"><p>What: IOMMU maps physical memory to virtual memory, which is critical for device passthrough (e.g., PCIe devices) in virtualized environments. It ensures that VMs can securely and efficiently use hardware devices.</p></li></ul><section><h4 id="1469606077#intel-known-as-vt-d-intel-virtualization-technology-for-directed-i-o" data-toc="intel-known-as-vt-d-intel-virtualization-technology-for-directed-i-o#GettingStarted.md-intel-known-as-vt-d-intel-virtualization-technology-for-directed-i-o">Intel: Known as VT-d (Intel Virtualization Technology for Directed I/O).</h4><ul class="list" id="1469606077#-doz6rh_49" start="1"><li class="list-item" id="1469606077#-doz6rh_50"><p>How: Enable &quot;VT-d&quot; or &quot;Intel VT for Directed I/O&quot; in the BIOS/UEFI settings.</p></li></ul></section><section><h4 id="1469606077#amd-often-referred-to-simply-as-iommu" data-toc="amd-often-referred-to-simply-as-iommu#GettingStarted.md-amd-often-referred-to-simply-as-iommu">AMD: Often referred to simply as &quot;IOMMU.&quot;</h4><ul class="list" id="1469606077#-doz6rh_51" start="1"><li class="list-item" id="1469606077#-doz6rh_52"><p>How: Enable &quot;IOMMU&quot; or &quot;AMD-Vi&quot; in the BIOS/UEFI.</p></li></ul></section></section></li></ol></section><section><h2 id="1469606077#2-check-iommu" data-toc="2-check-iommu#GettingStarted.md-2-check-iommu">2. Check IOMMU</h2><p id="1469606077#-doz6rh_53">Ensure Your Kernel Supports IOMMU and VFIO:</p><div class="detached code-block" id="1469606077#-doz6rh_54"><pre><code class="language-bash">LC_ALL=C.UTF-8 lscpu | grep Virtualization</code></pre></div><p id="1469606077#-doz6rh_55">See kernel support:</p><div class="detached code-block" id="1469606077#-doz6rh_56"><pre><code class="language-bash">zgrep CONFIG_KVM= /proc/config.gz
lsmod | grep kvm
lsmod | grep vfio
lsmod | grep virtio</code></pre></div></section><section><h2 id="1469606077#3-configure-grub" data-toc="3-configure-grub#GettingStarted.md-3-configure-grub">3. Configure Grub</h2><p id="1469606077#-doz6rh_57">We are going to configure GRUB first.</p><div class="detached code-block" id="1469606077#-doz6rh_58"><pre><code class="language-bash">sudo nano /etc/default/grub</code></pre></div><p id="1469606077#-doz6rh_59">Add intel or amd iommu to on:</p><div class="detached code-block" id="1469606077#-doz6rh_60"><pre><code class="language-bash">GRUB_CMDLINE_LINUX_DEFAULT=&quot; ... intel_iommu=on ...&quot;</code></pre></div><p id="1469606077#-doz6rh_61">Then update grub:</p><div class="detached code-block" id="1469606077#-doz6rh_62"><pre><code class="language-bash">sudo grub-mkconfig -o /boot/grub/grub.cfg</code></pre></div></section><section><h2 id="1469606077#4-load-missing-modules" data-toc="4-load-missing-modules#GettingStarted.md-4-load-missing-modules">4. Load Missing Modules</h2><p id="1469606077#-doz6rh_63">In case something was not correctly loaded when checking IOMMU, we are going to load the missing modules.</p><p id="1469606077#-doz6rh_64">Create a file /etc/modules-load.d/vfio.conf</p><p id="1469606077#-doz6rh_65">And write the modules</p><div class="detached code-block" id="1469606077#-doz6rh_66"><pre><code class="language-bash">sudo nano /etc/modules-load.d/vfio.conf

vfio
vfio_iommu_type1
vfio_pci</code></pre></div></section><section><h2 id="1469606077#5-isolate-the-gpu" data-toc="5-isolate-the-gpu#GettingStarted.md-5-isolate-the-gpu">5. Isolate the GPU</h2><p id="1469606077#-doz6rh_67">We need to find the IDs for our GPU, since we are going to pass-through.</p><div class="detached code-block" id="1469606077#-doz6rh_68"><pre><code class="language-bash">lspci -nn</code></pre></div><p id="1469606077#-doz6rh_69">We will find a lot of information, but we only need to pick both the NVIDIA Graphics and it's Audio.</p><div class="detached code-block" id="1469606077#-doz6rh_70"><pre><code class="language-bash">01:00.0 VGA compatible controller [0300]: NVIDIA Corporation AD103 [GeForce RTX 4080] [10de:2704] (rev a1)
01:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:22bb] (rev a1)</code></pre></div><p id="1469606077#-doz6rh_71">Now we create a file /etc/modprobe.d/vfio.conf</p><div class="detached code-block" id="1469606077#-doz6rh_72"><pre><code class="language-bash">options vfio-pci ids=10de:2704,10de:22bb
softdep nvidia pre: vfio-pci</code></pre></div><p id="1469606077#-doz6rh_73">I use my ids, from both the VGA and the Audio device, split by comma.</p><p id="1469606077#-doz6rh_74">The <span class="emphasis" id="1469606077#-doz6rh_75">softdep</span> line is to make sure we isolate the GPU before the driver.</p></section><section><h2 id="1469606077#6-after-reboot" data-toc="6-after-reboot#GettingStarted.md-6-after-reboot">6. After Reboot.</h2><p id="1469606077#-doz6rh_76">We can check finally if everything we did is correct.</p><p id="1469606077#-doz6rh_77">Here is a nice script to check the IOMMU groups:</p><div class="detached code-block" id="1469606077#-doz6rh_78"><pre><code class="language-bash">#!/bin/bash
shopt -s nullglob
for g in $(find /sys/kernel/iommu_groups/* -maxdepth 0 -type d | sort -V); do
    echo &quot;IOMMU Group ${g##*/}:&quot;
    for d in $g/devices/*; do
        echo -e &quot;\t$(lspci -nns ${d##*/})&quot;
    done;
done;</code></pre></div><p id="1469606077#-doz6rh_79">If we execute this we can find if our GPU is in an isolated group. Mine's in group 13.</p><div class="detached code-block" id="1469606077#-doz6rh_80"><pre><code class="language-bash">IOMMU Group 13:
	01:00.0 VGA compatible controller [0300]: NVIDIA Corporation AD103 [GeForce RTX 4080] [10de:2704] (rev a1)
	01:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:22bb] (rev a1)</code></pre></div><p id="1469606077#-doz6rh_81">Now we can check which driver is taking our NVIDIA.</p><div class="detached code-block" id="1469606077#-doz6rh_82"><pre><code class="language-bash">lspci -nnk</code></pre></div><p id="1469606077#-doz6rh_83">We should see that the driver in use is vfio-pci:</p><div class="detached code-block" id="1469606077#-doz6rh_84"><pre><code class="language-bash">01:00.0 VGA compatible controller [0300]: NVIDIA Corporation AD103 [GeForce RTX 4080] [10de:2704] (rev a1)
	Subsystem: Micro-Star International Co., Ltd. [MSI] Device [1462:5110]
	Kernel driver in use: vfio-pci
	Kernel modules: nouveau, nvidia_drm, nvidia
01:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:22bb] (rev a1)
	Subsystem: Micro-Star International Co., Ltd. [MSI] Device [1462:5110]
	Kernel driver in use: vfio-pci
	Kernel modules: snd_hda_intel</code></pre></div><p id="1469606077#-doz6rh_85">This is cool, we can pass this GPU without issues!</p><p id="1469606077#-doz6rh_86">You can continue next to setting up the virtual machine!</p></section></article></div></section><section class="topic"><div><article class="article"><h1 class="main-title" id="2092192844">Setting up virtual machine</h1><p id="2092192844#z6gfqok_3">We need to install some packages:</p><div class="detached code-block" id="2092192844#z6gfqok_4"><pre><code class="language-bash">sudo pacman -S qemu-desktop dnsmasq virt-manager ebtables libvirt edk2-ovmf swtpm</code></pre></div><p id="2092192844#z6gfqok_5">We will need to activate the default NAT network:</p><div class="detached code-block" id="2092192844#z6gfqok_6"><pre><code class="language-bash">virsh net-autostart default
virsh net-start default</code></pre></div><p id="2092192844#z6gfqok_7">The process of setting up a virtual machine using virt-manager is mostly self-explanatory, as most of the process comes with fairly comprehensive on-screen instructions.</p><p id="2092192844#z6gfqok_8">However, you should pay special attention to the following steps:</p><ul class="list" id="2092192844#z6gfqok_9" start="1"><li class="list-item" id="2092192844#z6gfqok_13"><p>When the virtual machine creation wizard asks you to name your virtual machine (<span class="control" id="2092192844#z6gfqok_16">final step before clicking &quot;Finish&quot;</span>), check the <span class="control" id="2092192844#z6gfqok_17">&quot;Customize before install&quot; checkbox</span>.</p></li><li class="list-item" id="2092192844#z6gfqok_14"><p>Select the BIOS and search for the UEFI with secureboot for our x64 platform.</p></li><li class="list-item" id="2092192844#z6gfqok_15"><p>In the &quot;CPUs&quot; section, adjust your socket, cores and threads per core, make sure to verify you are sending the correct setup.</p></li></ul><p id="2092192844#z6gfqok_10">Since we are installing Windows 11, we need also a TPM2. Since we installed <span class="emphasis" id="2092192844#z6gfqok_18">swtpm</span>, we can &quot;Add Hardware&quot; and we should see a TPM2 Emulator.</p><p id="2092192844#z6gfqok_11">(Check also if you want to use virtio for your main disk now)</p><p id="2092192844#z6gfqok_12">Then we are ready to install the OS as normal.</p></article></div></section><section class="topic"><div><article class="article"><h1 class="main-title" id="617518144">VM Configuration</h1><p id="617518144#-s59zq8_3">Now we are going to configure the VM.</p><p id="617518144#-s59zq8_4">First of all, shut down your VM!</p><p id="617518144#-s59zq8_5">We need to set up Virt-Manager under Settings or Preferences, to allow us to edit XML.</p><section><h2 id="617518144#mouse-keyboard-evdev" data-toc="mouse-keyboard-evdev#VM-Configuration.md-mouse-keyboard-evdev">Mouse &amp; Keyboard (evdev)</h2><p id="617518144#-s59zq8_11">We are going to tackle the mouse and keyboard. Right now we have Spice and a virtual monitor to us, which captures the mouse and keyboard, however is best to send them using evdev.</p><p id="617518144#-s59zq8_12">Firs we need to get the devices ID of our mouse and keyboard:</p><div class="detached code-block" id="617518144#-s59zq8_13"><pre><code class="language-bash">ls -l /dev/input/by-id/</code></pre></div><p id="617518144#-s59zq8_14">You will get something like this:</p><div class="detached code-block" id="617518144#-s59zq8_15"><pre><code class="language-bash">lrwxrwxrwx 1 root root 10 Jul 24 19:57 usb-Corsair_CORSAIR_HS80_MAX_WIRELESS_Gaming_Receiver_592466F35C4EC86F-event-if03 -&gt; ../event24
lrwxrwxrwx 1 root root 10 Jul 24 19:57 usb-Corsair_LCD_Cap_for_Elite_Capellix_coolers_1416221080004-event-if00 -&gt; ../event22
lrwxrwxrwx 1 root root 10 Jul 24 19:57 usb-Microsoft_Controller_3032363330313135383532323033-event-joystick -&gt; ../event26
lrwxrwxrwx 1 root root  6 Jul 24 19:57 usb-Microsoft_Controller_3032363330313135383532323033-joystick -&gt; ../js0
lrwxrwxrwx 1 root root 10 Jul 24 19:57 usb-monsgeek_MonsGeek_Keyboard-event-if02 -&gt; ../event15
lrwxrwxrwx 1 root root 10 Jul 24 19:57 usb-monsgeek_MonsGeek_Keyboard-event-kbd -&gt; ../event14
lrwxrwxrwx 1 root root 10 Jul 24 19:57 usb-monsgeek_MonsGeek_Keyboard-if02-event-kbd -&gt; ../event17
lrwxrwxrwx 1 root root 10 Jul 24 19:57 usb-Razer_Razer_Viper_Ultimate_000000000000-event-if01 -&gt; ../event20
lrwxrwxrwx 1 root root 10 Jul 24 19:57 usb-Razer_Razer_Viper_Ultimate_000000000000-event-mouse -&gt; ../event18
lrwxrwxrwx 1 root root 10 Jul 24 19:57 usb-Razer_Razer_Viper_Ultimate_000000000000-if01-event-kbd -&gt; ../event19
lrwxrwxrwx 1 root root 10 Jul 24 19:57 usb-Razer_Razer_Viper_Ultimate_000000000000-if02-event-kbd -&gt; ../event21
lrwxrwxrwx 1 root root  9 Jul 24 19:57 usb-Razer_Razer_Viper_Ultimate_000000000000-mouse -&gt; ../mouse0</code></pre></div><p id="617518144#-s59zq8_16">Im going to use my MonsGeek keyboard and my Razer Viper mouse. For that we need to look at the event name of each one. In my case they are:</p><div class="detached code-block" id="617518144#-s59zq8_17"><pre><code class="language-bash">usb-Razer_Razer_Viper_Ultimate_000000000000-event-mouse
usb-monsgeek_MonsGeek_Keyboard-event-kbd</code></pre></div><p id="617518144#-s59zq8_18"><span class="control" id="617518144#-s59zq8_24">IMPORTANT</span></p><p id="617518144#-s59zq8_19">Some devices will have other event like my keyboard has: <span class="control" id="617518144#-s59zq8_25">usb-monsgeek_MonsGeek_Keyboard-if02-event-kbd</span></p><p id="617518144#-s59zq8_20">Sometimes when adding these devices, and we want to get back the mouse and keyboard to the host, it will only pass the keyboard and not the mouse.</p><p id="617518144#-s59zq8_21">For that, we need to experiment, usually it is the if02 event of the keyboard. In my case, I need it, so I will use it from now on.</p><section><h3 id="617518144#configure-the-vm-xml-file" data-toc="configure-the-vm-xml-file#VM-Configuration.md-configure-the-vm-xml-file">Configure the VM XML file.</h3><p id="617518144#-s59zq8_26">Now that we have our devices, we will edit the VM using xml. (We can use a command or the virt-manager editor)</p><div class="detached code-block" id="617518144#-s59zq8_27"><pre><code class="language-bash">sudo EDITOR=nano virsh edit nameofyourvm</code></pre></div><p id="617518144#-s59zq8_28">We will add this configuration:</p><div class="detached code-block" id="617518144#-s59zq8_29"><pre><code class="language-markup">...
  &lt;devices&gt;
    ...
      &lt;input type=&quot;evdev&quot;&gt;
          &lt;source dev=&quot;/dev/input/by-id/usb-monsgeek_MonsGeek_Keyboard-if02-event-kbd&quot; grab=&quot;all&quot; grabToggle=&quot;ctrl-ctrl&quot; repeat=&quot;on&quot;/&gt;
      &lt;/input&gt;
      &lt;input type=&quot;evdev&quot;&gt;
          &lt;source dev=&quot;/dev/input/by-id/usb-monsgeek_MonsGeek_Keyboard-event-kbd&quot;/&gt;
      &lt;/input&gt;
      &lt;input type=&quot;evdev&quot;&gt;
          &lt;source dev=&quot;/dev/input/by-id/usb-Razer_Razer_Viper_Ultimate_000000000000-event-mouse&quot;/&gt;
      &lt;/input&gt;
    ...
  &lt;/devices&gt;</code></pre></div><p id="617518144#-s59zq8_30">You can see my if02-event-kbd has the options grab grabToggle and repeat, this is the device which recognized better in my machine. Instead of the regular -event-kbd. For you it might work with the regular one or you might have to use one of the if02.</p><p id="617518144#-s59zq8_31">In either case, you need to also pass the default -event-kbd if you needed the if02 as you see in my example.</p></section><section><h3 id="617518144#check" data-toc="check#VM-Configuration.md-check">Check</h3><p id="617518144#-s59zq8_32">If we boot the machine now, the VM will take instantly control over our mouse and keyboard, if you press <span class="inline-code" id="617518144#-s59zq8_33">CTRL + CTRL</span>, both CTRL buttons on your keyboard, the mouse and keyboard should respond back in the host. If that is not the case, please check the step before.</p></section></section><section><h2 id="617518144#gpu-pass-through" data-toc="gpu-pass-through#VM-Configuration.md-gpu-pass-through">GPU pass-through</h2><p id="617518144#-s59zq8_34">This is actually an easy one, we just isolated the graphics card, so we can just go over the GUI (virt-manager), click on 'Add Hardware' and select &quot;PCI Host Device&quot;, we should find our NVIDIA VGA and its Audio Device, we need to add both.</p><p id="617518144#-s59zq8_35">Now the VM will have direct access to it.</p></section><section><h2 id="617518144#disable-virtual-monitor" data-toc="disable-virtual-monitor#VM-Configuration.md-disable-virtual-monitor">Disable Virtual Monitor</h2><p id="617518144#-s59zq8_36">In my setup I use a DisplayPort cable connected to my monitor second input, so I do not need to see or have a screen sharing of the machine.</p><p id="617518144#-s59zq8_37">Therefore, I will disable spice, and the monitor (virtual one). For that, we need to remove these entries from the XML all at once.</p><div class="detached code-block" id="617518144#-s59zq8_38"><pre><code class="language-markup">...
&lt;audio id=&quot;1&quot; type=&quot;spice&quot;/&gt;
...
&lt;graphics type=&quot;spice&quot; autoport=&quot;yes&quot;&gt;
    &lt;listen type=&quot;address&quot;/&gt;
    &lt;image compression=&quot;off&quot;/&gt;
&lt;/graphics&gt;
...
&lt;channel type=&quot;spicevmc&quot;&gt;
    &lt;target type=&quot;virtio&quot; name=&quot;com.redhat.spice.0&quot;/&gt;
    &lt;address type=&quot;virtio-serial&quot; controller=&quot;0&quot; bus=&quot;0&quot; port=&quot;1&quot;/&gt;
&lt;/channel&gt;
...
&lt;redirdev bus=&quot;usb&quot; type=&quot;spicevmc&quot;&gt;
    &lt;address type=&quot;usb&quot; bus=&quot;0&quot; port=&quot;1&quot;/&gt;
&lt;/redirdev&gt;
...</code></pre></div><p id="617518144#-s59zq8_39">Save the file and start your machine again, nothing will display but your external monitor should show you still the DisplayPort signal, with only that monitor. (Physical)</p></section><section><h2 id="617518144#include-virtio-disks" data-toc="include-virtio-disks#VM-Configuration.md-include-virtio-disks">Include Virtio Disks</h2><p id="617518144#-s59zq8_40">If you have installed Virtio drivers from redhat / fedora binaries to your window's machine. Check Wiki Virtio (<a href="https://wiki.archlinux.org/title/QEMU#Installing_virtio_drivers">https://wiki.archlinux.org/title/QEMU#Installing_virtio_drivers</a>) You can hook up any other internal drivers you have to that machine like this:</p><div class="detached code-block" id="617518144#-s59zq8_41"><pre><code class="language-markup">&lt;disk type='block' device='disk'&gt;
    &lt;driver name='qemu' type='raw' cache='writeback' io='threads' discard='unmap'/&gt;
    &lt;source dev='/dev/disk/by-id/ata-Samsung_SSD_870_EVO_4TB_S758NX0W502467Z'/&gt;
    &lt;target dev='sda' bus='scsi'/&gt;
&lt;/disk&gt;
&lt;controller type='scsi' index='0' model='virtio-scsi'&gt;
    &lt;driver iothread='1' queues='8'/&gt;
&lt;/controller&gt;</code></pre></div><p id="617518144#-s59zq8_42">If you get an error about io threads add also this line:</p><div class="detached code-block" id="617518144#-s59zq8_43"><pre><code class="language-markup">&lt;iothreads&gt;1&lt;/iothreads&gt;</code></pre></div></section><section><h2 id="617518144#get-audio-from-guest-to-your-host" data-toc="get-audio-from-guest-to-your-host#VM-Configuration.md-get-audio-from-guest-to-your-host">Get Audio from Guest to your Host</h2><p id="617518144#-s59zq8_45">If we want to hear the audio from the guest to the host, we can use PipeWire.</p><p id="617518144#-s59zq8_46">We can add this to our XML config:</p><div class="detached code-block" id="617518144#-s59zq8_47"><pre><code class="language-markup">&lt;audio id=&quot;1&quot; type=&quot;pipewire&quot; runtimeDir=&quot;/run/user/1000&quot;&gt;
    &lt;input name=&quot;qemuinput&quot;/&gt;
    &lt;output name=&quot;qemuoutput&quot;/&gt;
&lt;/audio&gt;</code></pre></div><p id="617518144#-s59zq8_48">Of course make sure you are user 1000 or set the user yourself.</p></section></article></div></section></div></body></html>